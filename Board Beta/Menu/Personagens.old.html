<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <title>Personagens</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    :root { color-scheme: light dark; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 24px; }
    table { border-collapse: collapse; width: 100%; }
    caption { text-align: left; font-weight: 600; margin-bottom: 8px; }
    th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
    thead th { background: #f0f0f0; }
    tr:nth-child(even) td { background: #f9f9f9; }
    .status { margin: 12px 0; font-size: 0.95rem; }
    .btn-link { color: #0b57d0; text-decoration: none; }
    .btn-link:hover { text-decoration: underline; }
  </style>
</head>
<body>

  <h1>Personagens</h1>

  <div class="status" id="status">Carregando lista…</div>

  <table id="tbl">
    <caption>Lista de personagens</caption>
    <thead>
      <tr>
        <th scope="col">Nome</th>
        <th scope="col">Título</th>
        <th scope="col">Classe</th>
        <th scope="col">Clã</th>
        <th scope="col">Ação</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
  // Utilitário: codifica apenas se necessário, preservando caminhos já válidos
  function encodeIfNeeded(path) {
    // Codifica apenas segmentos que contenham espaços ou caracteres não ASCII (ex.: á, ã, ç)
    return path.split('/').map(seg => /[^\w.-]/u.test(seg) ? encodeURIComponent(seg) : seg).join('/');
  }

  async function carregarLista() {
    const status = document.getElementById('status');
    try {
      const resp = await fetch('./personagens.json', { cache: 'no-store' });
      if (!resp.ok) throw new Error('Falha ao ler JSON: ' + resp.status + ' ' + resp.statusText);
      const itens = await resp.json();

      const tbody = document.querySelector('#tbl tbody');
      tbody.innerHTML = '';

      // Ordenação opcional por nome
      itens.sort((a, b) => a.nome.localeCompare(b.nome, 'pt-BR'));

      for (const p of itens) {
        const hrefRaw = String(p.arquivo || '');
        const href = encodeIfNeeded(hrefRaw); // cuida de espaços e acentos

        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${p.nome ?? ''}</td>
          <td>${p.titulo ?? ''}</td>
          <td>${p.classe ?? ''}</td>
          <td>${p.cla ?? ''}</td>
          <td><a class="btn-link" href="${href}">Abrir</a></td>
        `;
        tbody.appendChild(tr);
      }

      status.textContent = 'Pronto. Clique em Abrir para navegar.';
    } catch (e) {
      status.textContent = 'Erro ao carregar a lista: ' + e.message;
      console.error(e);
    }
  }

  document.addEventListener('DOMContentLoaded', carregarLista);
  </script>

</body>
</html>
